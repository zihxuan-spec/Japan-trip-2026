<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Japan Trip V51</title>
    <link rel="icon" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Zen+Old+Mincho:wght@400;600;700;900&family=Noto+Serif+JP:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary: #2E4B71; --accent: #C85554; --text-main: #333333; --text-sub: #666666; --bg-body: #F9F8F6;
            --bg-card: rgba(255, 255, 255, 0.92); --bg-nav: rgba(46, 75, 113, 0.95); --nav-text: #94a3b8; --nav-active: #ffffff;
            --border: rgba(46, 75, 113, 0.1); --modal-bg: #ffffff; --input-bg: #FDFDFD;
        }
        body {
            font-family: "Noto Serif JP", serif; color: var(--text-main); background-color: var(--bg-body);
            font-size: 17px; line-height: 1.75; -webkit-tap-highlight-color: transparent;
            padding-bottom: 140px; min-height: 100vh; overflow-x: hidden;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%232E4B71' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        body.dark-mode {
            --primary: #8faecf; --accent: #ff8a80; --text-main: #e0e0e0; --text-sub: #aaaaaa; --bg-body: #121212;
            --bg-card: rgba(30, 30, 40, 0.85); --bg-nav: rgba(20, 20, 30, 0.95); --nav-text: #555555; --nav-active: #8faecf;
            --border: rgba(255, 255, 255, 0.1); --modal-bg: #1e1e24; --input-bg: #2b2b36;
        }
        .bg-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.85); z-index: -1; pointer-events: none; }
        body.dark-mode .bg-overlay { background: rgba(0,0,0,0.8); }
        .jp-font { font-family: 'Zen Old Mincho', serif; }
        .glass-card { background: var(--bg-card); backdrop-filter: blur(10px); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        
        /* Navigation */
        .bottom-nav { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 420px; background: var(--bg-nav); backdrop-filter: blur(16px); border-radius: 60px; display: flex; justify-content: space-around; padding: 14px 0; z-index: 50; box-shadow: 0 15px 40px rgba(0,0,0,0.3); }
        .nav-item { text-align: center; color: var(--nav-text); transition: 0.3s; cursor: pointer; flex: 1; }
        .nav-item.active { color: var(--nav-active); transform: translateY(-3px); }
        .nav-text { font-size: 0.65rem; display: block; font-weight: bold; margin-top: 3px; font-family: sans-serif; }
        .nav-icon { font-size: 1.2rem; }

        /* Inputs & Buttons */
        input, select, textarea { width: 100%; padding: 14px 20px; margin-bottom: 20px; background: var(--input-bg); border: 1px solid var(--border); color: var(--text-main); font-family: "Noto Serif JP", serif; font-size: 16px; border-radius: 12px; letter-spacing: 0.05em; outline: none; }
        .btn-primary { background-color: var(--primary); color: #fff; padding: 14px; width: 100%; border-radius: 12px; font-weight: bold; letter-spacing: 0.1em; cursor: pointer; }
        .btn-circle { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.2); backdrop-filter: blur(5px); color: var(--primary); border: 1px solid var(--border); transition: 0.2s; }

        /* Modals */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-overlay.active { display: flex; }
        .modal-content { background: var(--modal-bg); width: 92%; max-width: 420px; padding: 30px; border-radius: 20px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); color: var(--text-main); }

        /* Header & Settings */
        header { background-color: var(--bg-body); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border); }
        .settings-menu { position: absolute; top: 70px; right: 20px; width: 220px; background: var(--modal-bg); border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); padding: 10px; display: none; z-index: 90; border: 1px solid var(--border); }
        .settings-menu.show { display: block; }
        .settings-item { padding: 12px; display: flex; align-items: center; gap: 10px; color: var(--text-main); font-size: 15px; border-radius: 8px; cursor: pointer; }
        .settings-item:hover { background: rgba(0,0,0,0.05); }

        /* Specific Components */
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #ccc; margin-left: 10px; display: inline-block; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .status-dot.online { background: #22c55e; box-shadow: 0 0 10px #22c55e; }
        .status-dot.error { background: #ef4444; }
        .shop-tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid var(--border); }
        .shop-tab { flex: 1; text-align: center; padding: 10px; font-weight: bold; color: var(--text-sub); cursor: pointer; font-family: "Zen Old Mincho", serif; }
        .shop-tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); }
        .type-selector { display: flex; justify-content: space-between; gap: 5px; margin-bottom: 24px; }
        .type-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px 0; border: 1px solid var(--border); border-radius: 8px; color: #999; cursor: pointer; background: var(--input-bg); font-size: 0.7rem; }
        .type-btn.active { background-color: var(--primary); color: white; border-color: var(--primary); }
        .img-box { width: 100%; height: 180px; object-fit: cover; border-radius: 12px; margin-bottom: 15px; display: none; }
        .img-box.show { display: block; }
        
        /* Loading */
        #loadingScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(46, 75, 113, 0.1); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #error-log { margin-top: 20px; padding: 15px; background: #fef2f2; border: 1px solid #ef4444; color: #b91c1c; border-radius: 8px; font-size: 12px; max-width: 80%; display: none; text-align: left; }
    </style>
</head>
<body class="default-bg">
    
    <div id="loadingScreen">
        <div class="spinner mb-4"></div>
        <div class="text-sm tracking-widest font-bold text-gray-400">LOADING...</div>
        <div id="error-log"></div>
    </div>

    <div class="bg-overlay"></div>
    <input type="file" id="bgInput" accept="image/*" hidden>
    <input type="file" id="shopImg" accept="image/*" hidden>
    <input type="file" id="editImg" accept="image/*" hidden>
    <input type="file" id="importInput" accept=".json" hidden>

    <header class="p-6 pt-12 sticky top-0 z-40 flex justify-between items-start transition-all">
        <div onclick="window.scrollTo(0,0)">
            <h1 id="appTitleMain" class="text-3xl font-black tracking-widest jp-font cursor-pointer" style="color:var(--primary)">JAPAN</h1>
            <div class="flex items-center mt-2">
                <p id="appSubtitle" class="text-xs tracking-[0.2em] uppercase font-sans font-bold" style="color:var(--text-sub)">2026.02.19 - 02.24</p>
                <div id="dbStatus" class="status-dot" title="Status"></div>
            </div>
        </div>
        <div>
            <button onclick="toggleSettings()" class="btn-circle"><i class="fas fa-cog"></i></button>
            <div id="settingsMenu" class="settings-menu">
                <div class="settings-item" onclick="toggleDarkMode()"><i class="fas fa-moon"></i> <span>深色模式</span></div>
                <div class="settings-item" onclick="triggerBgUpload()"><i class="fas fa-image"></i> <span>更換背景</span></div>
                <div class="settings-item" onclick="resetAllData()"><i class="fas fa-trash"></i> <span>重置所有</span></div>
            </div>
        </div>
    </header>

    <main id="app-content" class="p-5 max-w-lg mx-auto pb-32"></main>

    <nav class="bottom-nav">
        <div class="nav-item active" id="tab-schedule" onclick="switchTab('schedule')"><div class="nav-icon"><i class="fas fa-map-marked-alt"></i></div><span class="nav-text">行程</span></div>
        <div class="nav-item" id="tab-shopping" onclick="switchTab('shopping')"><div class="nav-icon"><i class="fas fa-shopping-bag"></i></div><span class="nav-text">購物</span></div>
        <div class="nav-item" id="tab-budget" onclick="switchTab('budget')"><div class="nav-icon"><i class="fas fa-wallet"></i></div><span class="nav-text">記帳</span></div>
        <div class="nav-item" id="tab-info" onclick="switchTab('info')"><div class="nav-icon"><i class="fas fa-passport"></i></div><span class="nav-text">資訊</span></div>
    </nav>

    <div id="shopModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-center mb-4 jp-font" style="color:var(--primary)">新增購物清單</h3>
            <div class="text-center mb-4">
                <div onclick="document.getElementById('shopImg').click()" class="border-2 border-dashed border-gray-300 rounded p-4 cursor-pointer text-gray-400 text-sm">
                    <i class="fas fa-camera text-2xl mb-1"></i><br>商品照片
                </div>
                <img id="shopPreview" class="img-box mt-2">
            </div>
            <div class="type-selector">
                <div class="type-btn active" onclick="setShopType('drug')" id="btn-shop-drug"><i class="fas fa-pills"></i><span>藥妝</span></div>
                <div class="type-btn" onclick="setShopType('snack')" id="btn-shop-snack"><i class="fas fa-cookie-bite"></i><span>零食</span></div>
                <div class="type-btn" onclick="setShopType('wear')" id="btn-shop-wear"><i class="fas fa-tshirt"></i><span>服飾</span></div>
                <div class="type-btn" onclick="setShopType('gift')" id="btn-shop-gift"><i class="fas fa-gift"></i><span>雜貨</span></div>
            </div>
            <input type="hidden" id="sType" value="drug">
            <input id="sName" placeholder="商品名稱">
            <textarea id="sNote" rows="2" placeholder="備註"></textarea>
            <button onclick="saveShopItem()" class="btn-primary mt-2">加入清單</button>
            <div class="text-center mt-3"><span onclick="closeModal('shopModal')" class="text-xs text-gray-400 underline cursor-pointer">取消</span></div>
        </div>
    </div>

    <script>
        // === GLOBAL VARIABLES ===
        const firebaseConfig = {
          apiKey: "AIzaSyCZ6-Io1jzxTLz4gzNW_Nf9er5As217erk",
          authDomain: "japan-fb8df.firebaseapp.com",
          projectId: "japan-fb8df",
          storageBucket: "japan-fb8df.firebasestorage.app",
          messagingSenderId: "395174393492",
          appId: "1:395174393492:web:118d202e6387787a1f2681",
          measurementId: "G-F1Y2PGN2R5"
        };

        const TRIP_DOC_ID = "trip_data_2026";
        let db;
        
        let data = { 
            config: { title: "JAPAN", subtitle: "2026.02.19 - 02.24", darkMode: false, bg: null },
            itinerary: [], 
            budget: [], 
            shopping: [], 
            info: { hotels: [], flightOut: {}, flightIn: {} },
            updatedAt: 0
        };
        
        let viewState = { tab: 'schedule', shopTab: 'tobuy' };

        // === FUNCTION DEFINITIONS (DEFINED BEFORE USE) ===

        function openShopModal() {
            document.getElementById('shopModal').classList.add('active');
            document.getElementById('sName').value = "";
            document.getElementById('sNote').value = "";
            document.getElementById('shopPreview').classList.remove('show');
            setShopType('drug');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function setShopType(type) {
            document.getElementById('sType').value = type;
            document.querySelectorAll('#shopModal .type-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-shop-' + type).classList.add('active');
        }

        function saveShopItem() {
            const name = document.getElementById('sName').value;
            const note = document.getElementById('sNote').value;
            const type = document.getElementById('sType').value;
            const img = document.getElementById('shopPreview').classList.contains('show') ? document.getElementById('shopPreview').src : "";
            
            if (name) {
                data.shopping.push({
                    id: Date.now(),
                    name: name,
                    note: note,
                    type: type,
                    checked: false,
                    img: img
                });
                saveData();
                closeModal('shopModal');
                render();
            }
        }

        function toggleShop(id) {
            const idx = data.shopping.findIndex(i => i.id === id);
            if (idx !== -1) {
                data.shopping[idx].checked = !data.shopping[idx].checked;
                saveData();
                render();
            }
        }

        function delShop(id) {
            if(confirm("Delete?")) {
                data.shopping = data.shopping.filter(i => i.id !== id);
                saveData();
                render();
            }
        }

        function render() {
            const box = document.getElementById('app-content');
            box.innerHTML = '';

            if (viewState.tab === 'shopping') {
                renderShoppingPage(box);
            } else if (viewState.tab === 'schedule') {
                box.innerHTML = '<div class="text-center text-gray-400 mt-10">行程頁面 (開發中)</div>';
            } else if (viewState.tab === 'budget') {
                box.innerHTML = '<div class="text-center text-gray-400 mt-10">記帳頁面 (開發中)</div>';
            } else {
                box.innerHTML = '<div class="text-center text-gray-400 mt-10">資訊頁面 (開發中)</div>';
            }
        }

        function renderShoppingPage(box) {
            const isToBuy = viewState.shopTab === 'tobuy';
            
            let html = `
                <div class="shop-tabs">
                    <div class="shop-tab ${isToBuy ? 'active' : ''}" onclick="switchShopTab('tobuy')">未完成</div>
                    <div class="shop-tab ${!isToBuy ? 'active' : ''}" onclick="switchShopTab('bought')">已完成</div>
                </div>
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold jp-font" style="color:var(--primary)">購物清單</h2>
                    <button onclick="openShopModal()" class="text-sm bg-[var(--primary)] text-white px-4 py-2 rounded-lg shadow-md font-bold">＋ 新增</button>
                </div>
                <div class="space-y-3">
            `;

            const filtered = data.shopping.filter(i => isToBuy ? !i.checked : i.checked);
            
            if (filtered.length === 0) {
                html += `<div class="text-center text-gray-400 py-10">尚無項目</div>`;
            } else {
                const types = { 'drug': '藥妝', 'snack': '零食', 'wear': '服飾', 'gift': '雜貨' };
                ['drug', 'snack', 'wear', 'gift'].forEach(type => {
                    const items = filtered.filter(i => i.type === type);
                    if (items.length > 0) {
                        html += `<div class="text-xs font-bold text-gray-400 mt-4 mb-2 pl-2 tracking-widest border-b pb-1">${types[type]}</div>`;
                        items.forEach(item => {
                            const checkClass = item.checked ? 'checked' : '';
                            const imgHtml = item.img ? `<img src="${item.img}" class="w-16 h-16 object-cover rounded mr-3">` : '';
                            html += `
                                <div class="glass-card p-3 flex items-center ${checkClass}">
                                    <div class="custom-checkbox mr-3 flex-shrink-0" onclick="toggleShop(${item.id})"><i class="fas fa-check text-xs"></i></div>
                                    ${imgHtml}
                                    <div class="flex-1">
                                        <div class="font-bold text-lg">${item.name}</div>
                                        <div class="text-xs text-gray-500">${item.note}</div>
                                    </div>
                                    <i class="fas fa-times text-gray-300 p-2 cursor-pointer" onclick="delShop(${item.id})"></i>
                                </div>
                            `;
                        });
                    }
                });
            }
            html += `</div>`;
            box.innerHTML = html;
        }

        function switchTab(t) {
            viewState.tab = t;
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + t).classList.add('active');
            render();
        }

        function switchShopTab(t) {
            viewState.shopTab = t;
            render();
        }

        // --- Data Handling ---
        function saveData() {
            data.updatedAt = Date.now();
            localStorage.setItem('trip_v51_local', JSON.stringify(data));
            
            const statusDot = document.getElementById('dbStatus');
            if (db) {
                db.collection("trips").doc(TRIP_DOC_ID).set(data)
                    .then(() => { statusDot.className = 'status-dot online'; })
                    .catch((e) => { 
                        console.error(e); 
                        statusDot.className = 'status-dot error'; 
                        alert("儲存失敗: " + e.message);
                    });
            }
        }

        // --- Image Handling ---
        function handleImgUpload(file, callback) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const cvs = document.createElement('canvas');
                    const ctx = cvs.getContext('2d');
                    const scale = 600 / img.width; // Compress size
                    cvs.width = 600;
                    cvs.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, cvs.width, cvs.height);
                    callback(cvs.toDataURL('image/jpeg', 0.6)); // Compress quality
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        document.getElementById('shopImg').onchange = (e) => handleImgUpload(e.target.files[0], (url) => {
            const img = document.getElementById('shopPreview');
            img.src = url;
            img.classList.add('show');
        });

        // --- Initialization ---
        window.addEventListener('DOMContentLoaded', () => {
            try {
                // Initialize Firebase
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();

                // 1. Load Local
                const local = localStorage.getItem('trip_v51_local');
                if (local) {
                    data = JSON.parse(local);
                }
                
                // 2. Initial Render
                render();
                
                // 3. Sync
                db.collection("trips").doc(TRIP_DOC_ID).onSnapshot((doc) => {
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('dbStatus').className = 'status-dot online';
                    
                    if (doc.exists) {
                        const cloudData = doc.data();
                        if (cloudData.updatedAt > data.updatedAt) {
                            console.log("Cloud update");
                            data = cloudData;
                            localStorage.setItem('trip_v51_local', JSON.stringify(data));
                            render();
                        }
                    } else {
                        // First time, save default
                        saveData();
                    }
                }, (error) => {
                    console.error("Firebase Error:", error);
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('dbStatus').className = 'status-dot error';
                    document.getElementById('error-log').style.display = 'block';
                    document.getElementById('error-log').innerText = "連線失敗: " + error.code;
                });

            } catch (e) {
                alert("Critical Init Error: " + e.message);
                document.getElementById('loadingScreen').style.display = 'none';
            }
        });

        // --- Other Utils ---
        function toggleSettings() { document.getElementById('settingsMenu').classList.toggle('show'); }
        function triggerBgUpload() { document.getElementById('bgInput').click(); }
        document.getElementById('bgInput').onchange = (e) => handleImgUpload(e.target.files[0], (url) => { data.config.bg = url; saveData(); applySettings(); });
        function applySettings() {
             if(data.config.bg) document.body.style.backgroundImage = `url(${data.config.bg})`;
        }

    </script>
</body>
</html>
