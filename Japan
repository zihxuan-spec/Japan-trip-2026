<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Japan Trip V9</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Zen+Old+Mincho:wght@400;700;900&family=Noto+Serif+JP:wght@300;500&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #2E4B71; /* 藍墨茶 */
            --text-color: #333333;
        }

        body {
            font-family: "Noto Serif JP", serif;
            color: var(--text-color);
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 120px;
            letter-spacing: 0.08em;
            background-color: #F9F8F6;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
            transition: background 0.5s ease;
        }
        
        /* 預設背景：和紙紋理 */
        body.default-bg {
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%232E4B71' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        /* 背景遮罩 */
        .bg-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.85); /* 預設濃度 */
            z-index: -1; pointer-events: none;
            backdrop-filter: blur(2px);
            transition: opacity 0.3s;
        }
        body.has-custom-bg .bg-overlay { opacity: 1; }
        body.default-bg .bg-overlay { opacity: 0; }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .jp-font { font-family: 'Zen Old Mincho', serif; }

        /* V6 風格導航列 */
        .bottom-nav {
            position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
            width: 85%; max-width: 380px;
            background: rgba(46, 75, 113, 0.95);
            backdrop-filter: blur(12px);
            border-radius: 60px;
            display: flex; justify-content: space-around;
            padding: 14px 0; z-index: 50;
            box-shadow: 0 15px 35px rgba(46, 75, 113, 0.25);
        }
        .nav-item { text-align: center; color: #94a3b8; transition: 0.3s; cursor: pointer; }
        .nav-item.active { color: white; transform: translateY(-2px); }
        .nav-text { font-size: 0.65rem; letter-spacing: 0.1em; margin-top: 2px; display: block; font-family: sans-serif; }
        .nav-icon { font-size: 1.2rem; }

        /* Day 卡片 (目錄) */
        .day-card {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(46, 75, 113, 0.1);
            padding: 24px 20px; margin-bottom: 16px;
            cursor: pointer; transition: all 0.3s ease; position: relative;
            box-shadow: 0 4px 15px rgba(46, 75, 113, 0.03);
            display: flex; align-items: center; justify-content: space-between;
        }
        .day-card:active { transform: scale(0.98); }
        .day-card:hover { border-color: var(--primary-color); }

        /* 讓地點變成可編輯的樣式 */
        .editable-location {
            transition: 0.2s; border-bottom: 1px solid transparent;
        }
        .editable-location:hover {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        /* 行程細節卡片 */
        .event-card {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(46, 75, 113, 0.1);
            margin-bottom: 20px; position: relative;
            box-shadow: 0 4px 20px rgba(0,0,0,0.04);
            overflow: hidden;
        }
        .card-img-container { width: 100%; height: 180px; overflow: hidden; display: none; background-color: #eee; }
        .card-img-container.has-img { display: block; }
        .card-img { width: 100%; height: 100%; object-fit: cover; }
        .card-body { padding: 18px; }
        .card-time {
            font-family: 'Zen Old Mincho', serif; font-weight: 700; font-size: 0.9rem; color: #2E4B71;
            border-bottom: 1px solid rgba(46, 75, 113, 0.15); padding-bottom: 8px; margin-bottom: 12px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .dot { width: 6px; height: 6px; transform: rotate(45deg); display: inline-block; margin-right: 10px; }
        .dot.transport { background-color: #5D7C9D; }
        .dot.food { background-color: #D68F4D; }
        .dot.sightseeing { background-color: #6D8C6F; }
        .dot.hotel { background-color: #8A6B9E; }

        /* 輸入與Modal */
        input, select, textarea {
            width: 100%; padding: 12px; margin-bottom: 12px;
            background: #FDFDFD; border: 1px solid #ddd;
            font-family: "Noto Serif JP", serif; font-size: 16px; border-radius: 2px;
        }
        .btn-primary {
            background-color: var(--primary-color); color: white; border: none; padding: 14px; width: 100%;
            font-family: 'Zen Old Mincho', serif; letter-spacing: 0.2em; font-weight: 700;
        }
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 100;
            align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: white; width: 90%; max-width: 420px; padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1); max-height: 90vh; overflow-y: auto;
        }

        /* 按鈕樣式 */
        .header-btn {
            width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
            border: 1px solid #2E4B71; color: #2E4B71; border-radius: 50%;
            cursor: pointer; transition: 0.3s; font-size: 12px;
        }
        .header-btn:active { background: #2E4B71; color: white; }
        .fade-in { animation: fadeIn 0.4s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .back-btn { display: inline-flex; align-items: center; gap: 6px; color: var(--primary-color); font-size: 0.9rem; margin-bottom: 20px; cursor: pointer; opacity: 0.7; font-family: 'Zen Old Mincho', serif; }
    </style>
</head>
<body class="default-bg">
    <div class="bg-overlay"></div>
    <input type="file" id="bgInput" accept="image/*" hidden>

    <header class="p-6 pt-12 sticky top-0 z-40 flex justify-between items-start">
        <div onclick="editTitle()">
            <h1 id="appTitleMain" class="text-3xl text-[#2E4B71] jp-font font-black tracking-widest leading-none cursor-pointer">JAPAN</h1>
            <p id="appSubtitle" class="text-[10px] text-gray-500 mt-2 tracking-[0.25em] uppercase font-sans">2026.02.19 - 02.24</p>
        </div>
        <div class="flex gap-2">
            <button onclick="triggerBgUpload()" class="header-btn" title="Change Background">
                <i class="fas fa-image"></i>
            </button>
            <button onclick="toggleLang()" class="header-btn font-sans font-bold" id="langBtn">中</button>
            <button onclick="resetAllData()" class="header-btn text-red-400 border-red-300">
                <i class="fas fa-redo"></i>
            </button>
        </div>
    </header>

    <main id="app-content" class="p-6 hide-scrollbar max-w-lg mx-auto pb-24">
        </main>

    <div id="editModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-xl text-center mb-8 jp-font font-bold text-[#2E4B71]" id="modalTitle">編輯行程</h3>
            <div class="mb-6 text-center border border-dashed border-gray-300 p-6 bg-gray-50">
                <label class="block text-xs text-gray-400 mb-2 tracking-widest cursor-pointer">
                    <i class="fas fa-camera text-2xl mb-2 block text-gray-300"></i>
                    <span id="txt-upload">上傳照片 / Upload Photo</span>
                    <input type="file" id="editImageFile" accept="image/*" class="hidden">
                </label>
                <div id="imagePreviewBox" class="hidden mt-4 relative">
                    <img id="imagePreview" src="" class="w-full h-40 object-cover shadow-sm">
                    <button onclick="clearImage()" class="absolute -top-2 -right-2 bg-[#2E4B71] text-white w-6 h-6 text-xs shadow-lg">✕</button>
                </div>
                <input type="hidden" id="editImageData">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <input type="text" id="editTime" placeholder="時間">
                <select id="editType">
                    <option value="sightseeing">觀光</option><option value="food">美食</option>
                    <option value="transport">交通</option><option value="hotel">住宿</option>
                </select>
            </div>
            <input type="text" id="editTitle" placeholder="標題" class="font-bold">
            <textarea id="editDesc" rows="3" placeholder="備註..."></textarea>
            <input type="text" id="editMap" placeholder="導航地點 (Google Maps)">
            <div class="flex gap-4 mt-6">
                <button onclick="deleteCurrentEvent()" id="btn-delete" class="flex-1 border border-gray-300 text-gray-400 text-xs tracking-widest">DELETE</button>
                <button onclick="saveEdit()" id="btn-save" class="flex-[2] btn-primary text-xs">SAVE</button>
            </div>
            <button onclick="closeModal()" id="btn-cancel" class="w-full mt-6 text-xs text-gray-400 underline tracking-widest">CANCEL</button>
        </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" id="tab-schedule" onclick="switchTab('schedule')">
            <div class="nav-icon"><i class="fas fa-list-ul"></i></div>
            <span class="nav-text" id="nav-sched">行程</span>
        </div>
        <div class="nav-item" id="tab-info" onclick="switchTab('info')">
            <div class="nav-icon"><i class="fas fa-passport"></i></div>
            <span class="nav-text" id="nav-info">資訊</span>
        </div>
        <div class="nav-item" id="tab-budget" onclick="switchTab('budget')">
            <div class="nav-icon"><i class="fas fa-coins"></i></div>
            <span class="nav-text" id="nav-budget">記帳</span>
        </div>
    </nav>

    <script>
        // === i18n ===
        const i18n = {
            'zh-TW': {
                navSched:'行程', navInfo:'資訊', navBudget:'記帳', day:'Day', navBtn:'導航',
                addEvent:'＋ 新增行程', modalEdit:'編輯行程', modalAdd:'新增行程',
                phTime:'時間', phTitle:'標題', phDesc:'備註...', phMap:'導航地點',
                btnSave:'儲存', btnDel:'刪除', btnCancel:'取消', flights:'航班資訊', hotels:'住宿資訊',
                totalSpent:'總花費', splitBill:'分帳計算機', item:'項目', amount:'金額', people:'人數', calc:'計算', addList:'加入清單',
                curr:'¥', perPerson:'/ 人', back:'← 返回目錄', viewList:'行程總覽',
                editLocPrompt: '修改該日地點名稱：'
            },
            'en': {
                navSched:'SCHEDULE', navInfo:'INFO', navBudget:'BUDGET', day:'Day', navBtn:'NAV',
                addEvent:'＋ ADD EVENT', modalEdit:'EDIT', modalAdd:'NEW',
                phTime:'Time', phTitle:'Title', phDesc:'Note...', phMap:'Map Keyword',
                btnSave:'SAVE', btnDel:'DELETE', btnCancel:'CANCEL', flights:'FLIGHTS', hotels:'HOTELS',
                totalSpent:'TOTAL SPENT', splitBill:'SPLIT BILL', item:'Item', amount:'Amount', people:'People', calc:'CALC', addList:'ADD TO LIST',
                curr:'JPY ', perPerson:'/ pp', back:'← BACK TO LIST', viewList:'OVERVIEW',
                editLocPrompt: 'Edit Location Name:'
            }
        };

        // === Data ===
        let currentLang = 'zh-TW';
        let appConfig = { title: "JAPAN", subtitle: "2026.02.19 - 02.24" };
        let scheduleViewMode = 'list';
        let activeDayIndex = 0;
        let itinerary = [];
        let budgetList = [];

        const defaultItinerary = [
            { day: 1, date: "02/19 (四)", location: "東京・淺草", events: [
                { id: 101, type: "transport", time: "22:00", title: "抵達成田 (NRT)", desc: "Skyliner 直奔淺草。", map: "Narita Airport" },
                { id: 102, type: "hotel", time: "23:30", title: "Check-in: 御宿 野乃", desc: "免費宵夜拉麵。", map: "Onyado Nono Asakusa" }
            ]},
            { day: 2, date: "02/20 (五)", location: "千葉・舞濱", events: [
                { id: 201, type: "sightseeing", time: "ALL DAY", title: "東京迪士尼", desc: "全日遊玩。", map: "Tokyo Disney Resort" }
            ]},
            { day: 3, date: "02/21 (六)", location: "東京市區", events: [
                { id: 301, type: "food", time: "09:00", title: "築地場外市場", desc: "海鮮丼。", map: "Tsukiji Outer Market" },
                { id: 302, type: "sightseeing", time: "13:00", title: "秋葉原", desc: "Bic Camera。", map: "Akihabara" },
                { id: 303, type: "sightseeing", time: "17:00", title: "東京鐵塔", desc: "夜景。", map: "Tokyo Tower" }
            ]},
            { day: 4, date: "02/22 (日)", location: "新宿/澀谷", events: [
                { id: 401, type: "transport", time: "10:00", title: "搬家", desc: "前往新宿飯店。", map: "Shinjuku Station" },
                { id: 402, type: "sightseeing", time: "14:00", title: "Shibuya Sky", desc: "預約制觀景台。", map: "SHIBUYA SKY" }
            ]},
            { day: 5, date: "02/23 (一)", location: "河口湖", events: [
                { id: 501, type: "transport", time: "07:30", title: "河口湖一日遊", desc: "高速巴士。", map: "Busta Shinjuku" },
                { id: 502, type: "sightseeing", time: "10:30", title: "大石公園", desc: "富士山景。", map: "Oishi Park" }
            ]},
            { day: 6, date: "02/24 (二)", location: "返國", events: [
                { id: 601, type: "sightseeing", time: "11:00", title: "原宿", desc: "最後購物。", map: "Harajuku" },
                { id: 602, type: "transport", time: "18:00", title: "前往機場", desc: "搭機返台。", map: "Narita Airport" }
            ]}
        ];
        
        const staticInfo = { flights: [{code:"CI 104", route:"TPE -> NRT"}, {code:"CI 105", route:"NRT -> TPE"}], hotels: [{name:"御宿 野乃淺草", map:"Onyado Nono Asakusa"}, {name:"新宿飯店", map:"Shinjuku Station"}] };

        // === Init & Storage ===
        function loadAllData() {
            const sTitle = localStorage.getItem('v9_config'); if(sTitle) appConfig = JSON.parse(sTitle);
            const sSched = localStorage.getItem('v9_sched'); itinerary = sSched ? JSON.parse(sSched) : JSON.parse(JSON.stringify(defaultItinerary));
            const sBudget = localStorage.getItem('v9_budget'); budgetList = sBudget ? JSON.parse(sBudget) : [];
            const sLang = localStorage.getItem('v9_lang'); if(sLang) currentLang = sLang;
            const sBg = localStorage.getItem('v9_bg'); 
            if(sBg) { document.body.style.backgroundImage = `url(${sBg})`; document.body.classList.remove('default-bg'); document.body.classList.add('has-custom-bg'); }
            updateHeader(); updateLangUI();
        }
        function saveAllData() {
            localStorage.setItem('v9_config', JSON.stringify(appConfig)); localStorage.setItem('v9_sched', JSON.stringify(itinerary));
            localStorage.setItem('v9_budget', JSON.stringify(budgetList)); localStorage.setItem('v9_lang', currentLang);
        }
        function resetAllData() { if(confirm("Reset All Data?")) { localStorage.clear(); location.reload(); } }
        
        // === Background Logic ===
        function triggerBgUpload() { document.getElementById('bgInput').click(); }
        document.getElementById('bgInput').addEventListener('change', function(e) {
            const file = e.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                    const maxWidth = 1024; const scaleSize = maxWidth / img.width;
                    canvas.width = maxWidth; canvas.height = img.height * scaleSize;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    document.body.style.backgroundImage = `url(${dataUrl})`;
                    document.body.classList.remove('default-bg'); document.body.classList.add('has-custom-bg');
                    localStorage.setItem('v9_bg', dataUrl);
                }
                img.src = evt.target.result;
            }
            reader.readAsDataURL(file);
        });

        // === Core Logic ===
        function editTitle() { 
            const t = prompt("Title", appConfig.title); 
            if(t) { appConfig.title = t; appConfig.subtitle = prompt("Subtitle", appConfig.subtitle)||appConfig.subtitle; saveAllData(); updateHeader(); }
        }
        function updateHeader() { document.getElementById('appTitleMain').innerText = appConfig.title; document.getElementById('appSubtitle').innerText = appConfig.subtitle; }
        function toggleLang() { currentLang = currentLang === 'zh-TW' ? 'en' : 'zh-TW'; saveAllData(); updateLangUI(); switchTab(document.querySelector('.nav-item.active').id.replace('tab-','')); }
        function updateLangUI() {
            const t = i18n[currentLang];
            document.getElementById('langBtn').innerText = currentLang === 'zh-TW' ? '中' : 'EN';
            document.getElementById('nav-sched').innerText = t.navSched; document.getElementById('nav-info').innerText = t.navInfo; document.getElementById('nav-budget').innerText = t.navBudget;
            document.getElementById('editTime').placeholder = t.phTime; document.getElementById('editTitle').placeholder = t.phTitle; document.getElementById('editDesc').placeholder = t.phDesc; document.getElementById('editMap').placeholder = t.phMap;
            document.getElementById('btn-save').innerText = t.btnSave; document.getElementById('btn-delete').innerText = t.btnDel; document.getElementById('btn-cancel').innerText = t.btnCancel;
            document.getElementById('txt-upload').innerText = currentLang==='zh-TW'?'上傳照片':'Upload Photo';
        }

        // === NEW: Edit Day Location ===
        function editDayLocation(idx) {
            const day = itinerary[idx];
            const newLoc = prompt(i18n[currentLang].editLocPrompt, day.location);
            if(newLoc !== null && newLoc.trim() !== "") {
                itinerary[idx].location = newLoc;
                saveAllData();
                renderSchedule();
            }
        }

        // === Schedule View ===
        function switchTab(t) {
            document.querySelectorAll('.nav-item').forEach(el=>el.classList.remove('active'));
            document.getElementById('tab-'+t).classList.add('active');
            window.scrollTo(0,0);
            if(t!=='schedule') scheduleViewMode = 'list';
            if(t==='schedule') renderSchedule(); if(t==='info') renderInfo(); if(t==='budget') renderBudget();
        }
        function enterDay(idx) { scheduleViewMode = 'detail'; activeDayIndex = idx; renderSchedule(); window.scrollTo(0,0); }
        function goBackToList() { scheduleViewMode = 'list'; renderSchedule(); }

        function renderSchedule() {
            const c = document.getElementById('app-content'); c.innerHTML = ""; const t = i18n[currentLang];
            if (scheduleViewMode === 'list') {
                let html = `<div class="fade-in"><h2 class="text-sm text-gray-400 mb-6 tracking-widest uppercase border-b border-gray-300 pb-2 font-bold">${t.viewList}</h2>`;
                itinerary.forEach((day, idx) => {
                    html += `
                    <div class="day-card" onclick="enterDay(${idx})">
                        <div>
                            <div class="text-[#2E4B71] jp-font font-black text-xl mb-1">${t.day} ${day.day}</div>
                            <div class="text-xs text-gray-500 tracking-wider font-bold">${day.date}</div>
                        </div>
                        <div class="text-right">
                            <div onclick="event.stopPropagation(); editDayLocation(${idx})" class="text-sm text-[#333] mb-1 font-bold jp-font editable-location flex items-center justify-end gap-1">
                                <span>${day.location}</span>
                                <i class="fas fa-pen text-[10px] text-gray-300"></i>
                            </div>
                            <div class="text-[10px] text-gray-400 border border-gray-300 px-2 py-0.5 rounded-full inline-block">See Plan <i class="fas fa-chevron-right ml-1"></i></div>
                        </div>
                    </div>`;
                });
                c.innerHTML = html + "</div>";
            } else {
                const day = itinerary[activeDayIndex];
                let html = `<div class="fade-in"><div onclick="goBackToList()" class="back-btn font-bold">${t.back}</div>
                    <div class="flex items-end justify-between mb-6 border-l-4 border-[#2E4B71] pl-5 py-2 bg-white/50 backdrop-blur-sm rounded-r-lg"><div><h2 class="text-4xl text-[#2E4B71] jp-font font-black leading-none mb-2">${t.day} ${day.day}</h2><p class="text-sm text-gray-500 tracking-widest font-bold">${day.date}</p></div><div class="text-xl font-bold text-[#333] jp-font">${day.location}</div></div>`;
                day.events.forEach((evt, eIdx) => {
                    let nav = evt.map ? `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(evt.map)}" target="_blank" onclick="event.stopPropagation()" class="text-[#2E4B71] text-[10px] border border-[#2E4B71] px-2 py-0.5 rounded-sm hover:bg-[#2E4B71] hover:text-white transition">${t.navBtn}</a>` : '';
                    let imgHtml = evt.img ? `<div class="card-img-container has-img"><img src="${evt.img}" class="card-img"></div>` : '';
                    html += `<div class="event-card" onclick="openEditModal(${activeDayIndex}, ${eIdx})">${imgHtml}<div class="card-body"><div class="card-time"><span>${evt.time}</span>${nav}</div><div class="flex items-center mb-2"><span class="dot ${evt.type}"></span><h3 class="font-bold text-lg text-[#333] jp-font">${evt.title}</h3></div><p class="text-xs text-gray-600 leading-6 font-sans">${evt.desc}</p></div></div>`;
                });
                html += `<div onclick="openAddModal(${activeDayIndex})" class="text-center py-4 text-gray-500 border border-dashed border-gray-400 tracking-widest cursor-pointer hover:bg-white transition text-xs font-bold bg-white/30 backdrop-blur-sm">${t.addEvent}</div></div>`;
                c.innerHTML = html;
            }
        }

        // === Info & Budget (Standard) ===
        function renderInfo() {
            const t = i18n[currentLang];
            let html = `<div class="space-y-6 fade-in"><h2 class="text-xl font-bold text-[#2E4B71] jp-font border-b border-gray-300 pb-2">${t.flights}</h2>`;
            staticInfo.flights.forEach(f => { html += `<div class="bg-white/90 backdrop-blur p-5 shadow-sm border-l-2 border-[#2E4B71]"><div class="font-bold text-xl jp-font text-[#333]">${f.code}</div><div class="text-sm text-gray-500 mt-1 font-sans">${f.route}</div></div>`; });
            html += `<h2 class="text-xl font-bold text-[#2E4B71] jp-font border-b border-gray-300 pb-2 pt-4">${t.hotels}</h2>`;
            staticInfo.hotels.forEach(h => { html += `<div class="bg-white/90 backdrop-blur p-5 shadow-sm border-l-2 border-[#8A6B9E]"><div class="font-bold text-lg jp-font">${h.name}</div><a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(h.map)}" target="_blank" class="text-xs text-[#2E4B71] mt-2 block underline">MAP</a></div>`; });
            document.getElementById('app-content').innerHTML = html + "</div>";
        }
        function renderBudget() {
            const t = i18n[currentLang];
            let total = budgetList.reduce((a,c)=>a+c.amount,0);
            let html = `<div class="space-y-6 fade-in"><div class="text-center py-6 bg-white/50 backdrop-blur rounded-lg border border-gray-200"><div class="text-xs text-gray-500 mb-2 tracking-[0.2em] uppercase font-bold">${t.totalSpent}</div><div class="text-4xl font-bold text-[#2E4B71] jp-font">¥${total.toLocaleString()}</div></div><div class="bg-white/90 backdrop-blur p-6 shadow-sm border border-gray-100"><h3 class="font-bold text-sm mb-4 tracking-widest text-[#2E4B71]">${t.splitBill}</h3><input id="spItem" placeholder="${t.item}" class="text-sm bg-gray-50"><div class="flex gap-2"><input id="spAmt" type="number" placeholder="${t.amount}" class="text-sm bg-gray-50"><input id="spPpl" type="number" value="2" class="text-sm w-16 text-center bg-gray-50"></div><button onclick="calculateSplit()" class="btn-primary text-xs mt-2 shadow-md">${t.calc}</button><div class="mt-4 text-center"><div id="spRes" class="text-2xl font-bold text-[#C85554] jp-font">¥0</div><button id="addSpBtn" style="display:none" class="w-full mt-3 text-xs border border-[#2E4B71] text-[#2E4B71] py-3 hover:bg-[#2E4B71] hover:text-white transition tracking-widest">${t.addList}</button></div></div><div class="space-y-3">${budgetList.slice().reverse().map(b=>`<div class="bg-white/90 backdrop-blur p-4 border-l-2 border-[#2E4B71] shadow-sm flex justify-between items-center"><div><div class="font-bold text-[#333] jp-font">${b.item}</div><div class="text-[10px] text-gray-400 mt-1">${b.note}</div></div><div class="flex items-center gap-4"><span class="font-bold text-lg text-[#2E4B71]">¥${b.amount.toLocaleString()}</span><i onclick="delExp(${b.id})" class="fas fa-times text-gray-300 hover:text-red-400 cursor-pointer"></i></div></div>`).join('')}</div></div>`;
            document.getElementById('app-content').innerHTML = html;
        }

        // === Event Handlers ===
        document.getElementById('editImageFile').addEventListener('change', function(e) {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                    const maxWidth = 600; const scaleSize = maxWidth / img.width;
                    canvas.width = maxWidth; canvas.height = img.height * scaleSize;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.85);
                    document.getElementById('imagePreview').src = dataUrl;
                    document.getElementById('editImageData').value = dataUrl;
                    document.getElementById('imagePreviewBox').classList.remove('hidden');
                }
                img.src = event.target.result;
            }
            reader.readAsDataURL(file);
        });
        function clearImage() { document.getElementById('editImageFile').value = ""; document.getElementById('editImageData').value = ""; document.getElementById('imagePreviewBox').classList.add('hidden'); }
        let currentD = null, currentE = null, isEdit = false;
        function openEditModal(d, e) { currentD = d; currentE = e; isEdit = true; fillModal(i18n[currentLang].modalEdit, itinerary[d].events[e]); }
        function openAddModal(d) { currentD = d; isEdit = false; fillModal(i18n[currentLang].modalAdd, {time:"", title:"", type:"sightseeing", desc:"", map:"", img:""}); }
        function fillModal(title, data) {
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('editTime').value = data.time; document.getElementById('editTitle').value = data.title;
            document.getElementById('editType').value = data.type; document.getElementById('editDesc').value = data.desc;
            document.getElementById('editMap').value = data.map || "";
            if(data.img) { document.getElementById('editImageData').value = data.img; document.getElementById('imagePreview').src = data.img; document.getElementById('imagePreviewBox').classList.remove('hidden'); } 
            else clearImage();
            document.getElementById('editModal').classList.add('active');
        }
        function saveEdit() {
            const newEvt = { id: Date.now(), time: document.getElementById('editTime').value, title: document.getElementById('editTitle').value, type: document.getElementById('editType').value, desc: document.getElementById('editDesc').value, map: document.getElementById('editMap').value, img: document.getElementById('editImageData').value };
            if(!newEvt.title) return;
            if(isEdit) itinerary[currentD].events[currentE] = newEvt; else { itinerary[currentD].events.push(newEvt); itinerary[currentD].events.sort((a,b)=>a.time.localeCompare(b.time)); }
            saveAllData(); closeModal(); renderSchedule();
        }
        function deleteCurrentEvent() { if(!isEdit) { closeModal(); return; } if(confirm(i18n[currentLang].btnDel + "?")) { itinerary[currentD].events.splice(currentE, 1); saveAllData(); closeModal(); renderSchedule(); } }
        function closeModal() { document.getElementById('editModal').classList.remove('active'); }
        function calculateSplit() {
            const amt = parseFloat(document.getElementById('spAmt').value); const ppl = parseInt(document.getElementById('spPpl').value); const item = document.getElementById('spItem').value || i18n[currentLang].item;
            if(!amt || !ppl) return;
            const per = Math.ceil(amt/ppl);
            document.getElementById('spRes').innerText = i18n[currentLang].curr + per.toLocaleString();
            document.getElementById('addSpBtn').style.display='block'; document.getElementById('addSpBtn').innerText = i18n[currentLang].addList;
            document.getElementById('addSpBtn').onclick = () => { budgetList.push({id:Date.now(), item, amount:amt, note:`(${ppl} ${i18n[currentLang].people}: ${i18n[currentLang].curr}${per}${i18n[currentLang].perPerson})`}); saveAllData(); renderBudget(); document.getElementById('spAmt').value=''; document.getElementById('addSpBtn').style.display='none'; }
        }
        function delExp(id) { if(confirm(i18n[currentLang].btnDel + "?")) { budgetList=budgetList.filter(b=>b.id!==id); saveAllData(); renderBudget(); } }

        // Init
        loadAllData();
        renderSchedule();
    </script>
</body>
</html>
